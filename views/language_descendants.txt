CREATE OR REPLACE VIEW language_descendants AS
SELECT
  a.id,
  a.descendants
FROM (
  SELECT
    language.id,
    array_agg(b.id ORDER BY b.path) FILTER (WHERE b.id != language.id) AS descendants
  FROM language
  LEFT JOIN LATERAL (
    WITH RECURSIVE descendant(id, path) AS (
      SELECT language2.id, '{{"",""}}'::text[]
      FROM language language2
      WHERE language2.id = language.id
      UNION ALL
      SELECT language2.id, descendant.path || ARRAY[to_bool_text(protolanguage.id), lower(language2.name)]
      FROM descendant
      JOIN language language2 ON language2.parent_id = descendant.id AND language2.flag_language_list
      LEFT JOIN protolanguage ON protolanguage.id = language2.id
    )
    SELECT descendant.id, descendant.path
    FROM descendant
  ) b ON true
  GROUP BY language.id
) a;