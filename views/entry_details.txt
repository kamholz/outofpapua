CREATE OR REPLACE VIEW entry_details AS
SELECT
  entry.id,
  origin_language.name AS origin_language_name,
  entry.senses,
  json_build_object(
    'id', source.id,
    'reference', source.reference,
    'editable', source.editable,
    'ipa_conversion_rule', source.ipa_conversion_rule
  ) AS source,
  json_build_object(
    'id', language.id,
    'name', language.name,
    'location', language.location,
    'is_proto', protolanguage.id IS NOT NULL,
    'ancestor_id', language.ancestor_id,
    'ancestor_name', ancestor_language.name
  ) AS language
FROM entry
JOIN source ON source.id = entry.source_id
JOIN language ON language.id = source.language_id
LEFT JOIN protolanguage ON protolanguage.id = language.id
LEFT JOIN language origin_language ON origin_language.id = entry.origin_language_id
LEFT JOIN language ancestor_language ON ancestor_language.id = language.ancestor_id
;

CREATE OR REPLACE VIEW entry_details_public AS
SELECT
  entry.id,
  origin_language.name AS origin_language_name,
  entry.senses,
  json_build_object(
    'id', source.id,
    'reference', source.reference,
    'editable', source.editable,
    'ipa_conversion_rule', source.ipa_conversion_rule
  ) AS source,
  json_build_object(
    'id', language.id,
    'name', language.name,
    'location', language.location,
    'is_proto', protolanguage.id IS NOT NULL,
    'ancestor_id', language.ancestor_id,
    'ancestor_name', ancestor_language.name
  ) AS language
FROM entry
JOIN source ON source.id = entry.source_id
JOIN language ON language.id = source.language_id
LEFT JOIN protolanguage ON protolanguage.id = language.id
LEFT JOIN language origin_language ON origin_language.id = entry.origin_language_id
LEFT JOIN language ancestor_language ON ancestor_language.id = language.ancestor_id
WHERE source.public
;