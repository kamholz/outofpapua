CREATE OR REPLACE VIEW set_member_details AS
SELECT
  set_member.set_id,
  set_member.entry_id,
  json_build_object(
    'id', entry.id,
    'headword', entry.headword,
    'headword_degr', entry.headword_degr,
    'headword_ipa', entry.headword_ipa,
    'root', entry.root,
    'origin', entry.origin,
    'origin_language_id', entry.origin_language_id,
    'origin_language_name', ed.origin_language_name,
    'record_id', entry.record_id,
    'senses', entry.senses
  ) AS entry,
  ed.source,
  ed.language,
  (CASE WHEN set_member.multi_set IS FALSE THEN NULL ELSE (
    SELECT json_agg(
      json_build_object(
        'id', set.id,
        'name', coalesce(sna.name_auto->>'txt', set.id::text)
      )
      ORDER BY sna.name_auto->>'txt', lpad(set.id::text, 10, '0')
    )
    FROM set
    JOIN set_name_auto sna ON sna.id = set.id
    WHERE set.id != set_member.set_id AND EXISTS (
      SELECT FROM set_member sm WHERE sm.set_id = set.id AND sm.entry_id = set_member.entry_id
    )
  ) END) AS other_sets
FROM set_member
JOIN entry ON entry.id = set_member.entry_id
JOIN entry_details ed ON ed.id = set_member.entry_id
;

CREATE OR REPLACE VIEW set_member_details_public AS
SELECT
  set_member.set_id,
  set_member.entry_id,
  json_build_object(
    'id', entry.id,
    'headword', entry.headword,
    'headword_degr', entry.headword_degr,
    'headword_ipa', entry.headword_ipa,
    'root', entry.root,
    'origin', entry.origin,
    'origin_language_id', entry.origin_language_id,
    'origin_language_name', ed.origin_language_name,
    'record_id', entry.record_id,
    'senses', entry.senses
  ) AS entry,
  ed.source,
  ed.language,
  (CASE WHEN set_member.multi_set IS FALSE THEN NULL ELSE (
    SELECT json_agg(
      json_build_object(
        'id', set.id,
        'name', coalesce(sna.name_auto->>'txt', set.id::text)
      )
      ORDER BY sna.name_auto->>'txt', lpad(set.id::text, 10, '0')
    )
    FROM set
    JOIN set_name_auto_public sna ON sna.id = set.id
    WHERE set.id != set_member.set_id AND EXISTS (
      SELECT FROM set_member sm WHERE sm.set_id = set.id AND sm.entry_id = set_member.entry_id
    )
  ) END) AS other_sets
FROM set_member
JOIN entry ON entry.id = set_member.entry_id
JOIN entry_details_public ed ON ed.id = set_member.entry_id
;